# Simple Group Chat 機能一覧

## 1. リアルタイム通信機能

### WebSocketサーバー (`src/lib/websocket-server.ts`)
- **リアルタイムメッセージング**: WebSocket経由でのリアルタイムメッセージ送受信
- **プレゼンス管理**: オンラインユーザーの状態管理・通知
- **ルーム参加**: デフォルトルーム「default」への自動参加
- **コネクション管理**: ユーザー接続・切断の状態管理

### タイピングインジケータ
- **タイピング開始通知**: `typing_start` イベントでリアルタイム通知
- **タイピング停止通知**: `typing_stop` イベント + 3秒後自動停止
- **タイピング状態表示**: アクティブユーザーのタイピング状況をUI表示

### WebSocketクライアント (`src/lib/websocket-client.ts`)
- **自動再接続**: 接続断時の指数バックオフ再接続
- **接続状態管理**: connecting/connected/disconnected/reconnecting/error
- **差分同期**: `sinceTs`による効率的なメッセージ同期

---

## 2. 認証・セキュリティ機能

### Google OAuth認証 (`src/lib/auth.ts`)
- **NextAuth.js統合**: GoogleプロバイダーでのOAuth認証
- **JWT戦略**: Cookieベースのセッション管理（24時間有効）
- **プロフィール管理**: Google プロフィール情報（名前・ID）取得
- **セキュアCookie**: httpOnly, sameSite=lax 設定

### WebSocket認証
- **二段階認証**: HTTP session + JWT token による認証
- **Origin検証**: 許可されたオリジンからの接続のみ受付
- **認証フォールバック**: 複数の認証方法による堅牢性

### セキュリティ対策
- **レート制限**: トークンバケット方式（バースト10メッセージ、秒3メッセージ）
- **入力検証**: Zodスキーマによるランタイム型検証
- **テキストサニタイゼーション**: XSS対策のHTMLエスケープ

---

## 3. メッセージング機能

### メッセージ送受信
- **テキストメッセージ**: 2000文字制限のテキストメッセージ
- **リアルタイム配信**: ルーム内全ユーザーへの即座な配信
- **メッセージID**: ULID形式による一意識別子
- **タイムスタンプ**: Unix時間での正確な送信時刻記録

### メンション機能 (`src/utils/mentions.ts`)
- **メンション抽出**: `@username`形式での他ユーザー言及
- **大小文字非区別**: ケースインセンシティブなマッチング
- **メンションピッカー**: UI上での候補選択機能
- **ハイライト表示**: メンションされたユーザーの視覚的強調

### メッセージ履歴
- **永続化保存**: SQLiteでのメッセージ永続化
- **履歴取得**: 最新100件のメッセージ履歴
- **差分同期**: `sinceTs`パラメータでの増分同期
- **ページング**: `beforeId`による過去メッセージ取得（基本実装）

---

## 4. データベース・永続化機能

### SQLite データベース (`src/lib/database.ts`)
- **WALモード**: Write-Ahead Loggingによる同時実行性向上
- **最適化設定**: NORMAL同期モード、busy_timeout設定
- **インデックス**: room_id+ts降順、ts単体のインデックス
- **プリペアドステートメント**: SQL injection防止とパフォーマンス向上

### データ管理
- **メッセージリポジトリ**: CRUD操作の抽象化
- **自動クリーンアップ**: 24時間TTL + 500メッセージ/ルーム制限
- **バックグラウンドジョブ**: 毎分実行のクリーンアップ処理

---

## 5. UI/UXコンポーネント

### チャット画面 (`src/app/chat/page.tsx`)
- **メイン画面**: 認証済みユーザー向けチャット画面
- **セッション管理**: useSession hookによる認証状態管理
- **エラーハンドリング**: 包括的なエラー表示・回復機能

### メッセージリスト (`src/components/MessageList.tsx`)
- **メッセージ表示**: 時刻・送信者名・内容の構造化表示
- **自分メッセージ強調**: 送信者判定による視覚的区別
- **メンションハイライト**: @mentionの色付き表示
- **オンライン状態**: ユーザーの在線状況表示

### メッセージ作成 (`src/components/MessageComposer.tsx`)
- **リアルタイム入力**: タイピングインジケータ送信
- **入力検証**: 文字数制限・バリデーション
- **メンション候補**: @入力時の候補表示機能
- **送信制御**: 連投防止・送信中状態管理

### その他コンポーネント
- **ユーザーリスト**: オンラインユーザー一覧表示
- **チャットヘッダー**: ルーム情報・状態表示
- **エラー表示**: エラー種別に応じた適切なメッセージ表示

---

## 6. 品質・保守性機能

### テスト (`src/__tests__/`)
- **Unit テスト**: 個別機能のユニットテスト
  - メンション機能テスト
  - レート制限テスト
  - 認証ガードテスト
  - タイピングインジケータテスト
- **Integration テスト**: 複合機能のインテグレーションテスト
  - WebSocketフローテスト
  - リアルタイムメッセージングテスト
  - 差分同期テスト
- **Contract テスト**: WebSocketメッセージ仕様テスト
- **Acceptance テスト**: 受け入れ基準テスト
- **Load テスト**: 同時ユーザー負荷テスト

### 監視・ログ (`src/lib/monitoring.ts`, `src/lib/logger.ts`)
- **構造化ログ**: レベル別・コンポーネント別ログ出力
- **メトリクス収集**: システム健康状態の定量的監視
- **パフォーマンス追跡**: 応答時間・スループット測定
- **イベント追跡**: ユーザー行動の分析用イベント記録

### 開発支援
- **TypeScript**: 完全型安全な実装
- **Zod検証**: ランタイム型検証による堅牢性
- **ESLint**: コード品質・一貫性の自動チェック
- **Hot Reload**: 開発時の自動リロード機能

---

## 7. ユーティリティ機能

### テキスト処理
- **サニタイゼーション** (`src/utils/sanitize.ts`): XSS防止のHTMLエスケープ
- **URLリンク化**: 安全なリンク自動生成
- **時刻フォーマット** (`src/utils/time.ts`): ユーザーフレンドリーな時刻表示

### 状態管理
- **インメモリストア**: WebSocketサーバーでの高速状態管理
- **セッション管理**: Next.jsセッションとの統合
- **接続プール**: 効率的なWebSocket接続管理

---

## 8. 設定・環境

### 環境変数
- Google OAuth設定 (CLIENT_ID, CLIENT_SECRET)
- NextAuth設定 (URL, SECRET)
- データベース設定 (DATABASE_URL)
- 実行環境設定 (NODE_ENV)

### ビルド・デプロイ
- **Next.js ビルド**: 本番向け最適化ビルド
- **TypeScript コンパイル**: サーバーサイドTSコンパイル
- **開発サーバー**: TypeScript変更の自動ビルド・実行

---

## 更新履歴
- 2025/09/26: 初版作成（v0.1.0ベース）
- 2025/09/26: タイピングインジケータ機能追加反映